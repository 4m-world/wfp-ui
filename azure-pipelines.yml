trigger:
  - master
  - next
  - hotfix/*
  - bugfix/*
  - alpha/*
  - feat/performance-optimization

jobs:
- job: WFP_Design_System_publish
  pool:
    vmImage: 'ubuntu-latest'

  variables:
    NPM_CACHE_FOLDER: $(Pipeline.Workspace)/.npm
    nextRelease: unknown

  steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '14.x'
      displayName: 'Install Node.js'

#    - task: Cache@2
#      inputs:
#        key: 'npm | "$(Agent.OS)" | package-lock.json'
#        path: "$(NPM_CACHE_FOLDER)"
#        restoreKeys: |
#          npm | "$(Agent.OS)"
#          npm
#      displayName: 'Cache NPM packages'

    - script: |
        mkdir -p $(NPM_CACHE_FOLDER)
        yarn -v
        yarn install
      displayName: 'yarn install'

#    - script: |
#        yarn test
#      displayName: 'yarn test'

    - script: |
        yarn build
      displayName: 'yarn build'

    - script: |
        yarn publish:alpha-cli
      displayName: 'yarn build:alpha-cli'
      condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

    - task: GitHubRelease@1
      inputs:
        gitHubConnection: 'Utzel-Butzel'
        repositoryName: '$(Build.Repository.Name)'
        action: 'create'
        target: '$(Build.SourceVersion)'
        tagSource: 'gitTag'
        changeLogCompareToRelease: 'lastFullRelease'
        changeLogType: 'commitBased'
      condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

    - powershell: |
        echo "##vso[task.setvariable variable=versionNumber;isOutput=true]$(nextRelease)"
      name: setOutputVar

    - script: |
        npmVersionString=$(node -p "require('./packages/ui/package.json').version") 
        echo "##vso[build.updatebuildnumber]$npmVersionString"
      displayName: 'set build number'

    - script: |
        yarn build:storybook
      displayName: 'yarn build:storybook'
      env:
        STORYBOOK_INTERNAL_ASSETS: 
        STORYBOOK_NPM_VERSION: $(nextRelease)
        STORYBOOK_ASSETS: https://cdn.wfp.org/guides/ui/assets/v0.0.1/

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: "./packages/ui/docs"
        artifact: "wfp-ui-kit-build"
        publishLocation: "pipeline"

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: ".packages/ui/assets"
        artifact: "wfp-ui-kit-assets"
        publishLocation: "pipeline"